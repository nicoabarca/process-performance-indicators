name: Publish to PyPI

on:
  push:
    branches: [main]
    paths:
      - "process_performance_indicators/**"
      - "pyproject.toml"

permissions:
  contents: write
  id-token: write

concurrency:
  group: pypi-publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    # Skip version bump commits to prevent infinite loop
    if: "!startsWith(github.event.head_commit.message, 'chore: bump version to')"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: Get PR labels from merged commit
        id: pr-labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the PR number associated with this commit
          PR_NUMBER=$(gh pr list --state merged --search "${{ github.sha }}" --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No merged PR found for this commit"
            echo "version_type=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found PR #$PR_NUMBER"

          # Get labels from the PR
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name')
          echo "Labels: $LABELS"

          # Determine version bump type (priority: major > minor > patch)
          if echo "$LABELS" | grep -q "version:major"; then
            echo "version_type=major" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "version:minor"; then
            echo "version_type=minor" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "version:patch"; then
            echo "version_type=patch" >> $GITHUB_OUTPUT
          else
            echo "No version label found"
            echo "version_type=none" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ Set up Python 3.10
        if: steps.pr-labels.outputs.version_type != 'none'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ‡ Install uv
        if: steps.pr-labels.outputs.version_type != 'none'
        uses: astral-sh/setup-uv@v5

      - name: Bump version using uv
        if: steps.pr-labels.outputs.version_type != 'none'
        id: bump-version
        run: |
          VERSION_TYPE="${{ steps.pr-labels.outputs.version_type }}"
          echo "Bumping $VERSION_TYPE version..."

          # Bump version using uv (--frozen skips lock/sync)
          uv version --bump "$VERSION_TYPE" --frozen

          # Get the new version
          NEW_VERSION=$(uv version --frozen)
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push version bump
        if: steps.pr-labels.outputs.version_type != 'none'
        run: |
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.bump-version.outputs.new_version }}"
          git push

      - name: ğŸ“¦ Build package
        if: steps.pr-labels.outputs.version_type != 'none'
        run: uv build

      - name: ğŸš€ Publish to PyPI
        if: steps.pr-labels.outputs.version_type != 'none'
        run: uv publish --trusted-publishing always

      - name: ğŸ·ï¸ Create Git tag
        if: steps.pr-labels.outputs.version_type != 'none'
        run: |
          git tag "v${{ steps.bump-version.outputs.new_version }}"
          git push origin "v${{ steps.bump-version.outputs.new_version }}"
